<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Point OF Sales</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://pro.fontawesome.com/releases/v6.0.0-beta1/css/all.css"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav>
      <div class="container justify-content-between m-20">
        <div class="logo">
          <h3 class="m-0">Point Of Sales | Pusat</h3>
        </div>
        <div class="tanggal-jam">
          <div class="date">
            <p id="currentDate"></p>
          </div>
          <div class="time">
            <p id="currentTime"></p>
          </div>
        </div>
      </div>
    </nav>

    <section class="header">
      <div class="scan">
        <input type="text" />
        <p class="shortcut-btn">(F1)</p>
      </div>

      <div class="total">
        <p>Total</p>
        <p>0</p>
      </div>
    </section>

    <main>
      <div class="table">
        <table class="table table-striped mb-0 fw-500 text-white">
          <tr>
            <th>No.</th>
            <th>Kode Item</th>
            <th>Nama Item</th>
            <th>QTY</th>
            <th>Harga</th>
            <th>Disc.</th>
            <th>Pot.</th>
            <th>Subtotal</th>
          </tr>
        </table>
        <div class="no-data"></div>
      </div>
      <div class="fitur">
        <div
          class="col-3 d-flex flex-column justify-content-between"
          style="gap: 12px"
        >
          <script>
            var productsearchdata = [];
            document.addEventListener("turbo:load", function () {
              var timer;
              $(".searchProductInput").keyup(function (e) {
                if (e.key !== "Enter" || e.keyCode !== 13) {
                  clearTimeout(timer);
                  var ms = 100; // milliseconds
                  var val = this.value;
                  timer = setTimeout(function () {
                    searchProduct(val);
                  }, ms);
                }
              });
            });

            function add_to_cart(e) {
              let data = productsearchdata.find(
                (r) => r.id == ($(e).attr("data-id") || e)
              );
              data.product_discount = 0;
              data.product_cut_price = 0;
              console.log("add:", {
                data,
              });

              let c_apc = $("#customer").attr("data-additionalpricecategory");
              selected_product_data.push({
                ...data,
                product_quantity: 1,
                product_price:
                  data.additional_prices.find(
                    (r) =>
                      r.additional_price_category_id == c_apc &&
                      r.additional_price_unit_id == data.unit_id
                  )?.additional_price || data?.product_sell_price,
              });
              const product_modal = document.querySelector("#productModal");
              const modal = bootstrap.Modal.getInstance(product_modal);

              refresh_cart_list();
            }

            function add_promo(e) {
              console.log(e);
            }

            function searchProduct(val) {
              $.ajax({
                type: "POST",
                url: "https://poslite.bizkit.id/dashboard/product/selectajax",
                data: {
                  // "type": "check"
                  search: val,
                  page: 1,
                  // outlet_id: '',
                  saleable: 1,
                },
                success: function (response) {
                  $(".search_product_list").html("");
                  productsearchdata = response.data;

                  response.data.map((r, i) =>
                    $(".search_product_list").append(`
                              <tr class="lgi">
                                      <td>${r.product_code || "-"}</td>
                                      <td>${r.product_name}</td>
                                      <td class="text-end">${formatNumber(
                                        r.product_sell_price
                                      )}</td>
                                      <td class="text-end">${r.product_stock} ${
                      r.unit?.unit_name
                    }</td>
                                      <td class="text-end"><button data-id="${
                                        r.id
                                      }"  onclick="add_to_cart(this)" class="add-product">+</button></td>
                                  </tr>
                                  `)
                  );
                  // $('#productdataTable').DataTable({
                  //     "lengthChange": false,
                  //     language: {
                  //         searchPlaceholder: "Masukkan ID Item atau scan barcode"
                  //     }
                  // });
                },
              });
            }

            document.addEventListener("turbo:load", function () {
              $.ajax({
                type: "POST",
                url: "https://poslite.bizkit.id/dashboard/product/selectajax",
                data: {
                  // "type": "check"
                  search: null,
                  page: 1,
                  // outlet_id: '',
                  saleable: 1,
                },
                success: function (response) {
                  $(".search_product_list").html("");
                  productsearchdata = response.data;
                  response.data.map((r, i) =>
                    $(".search_product_list").append(`
                              <tr class="lgi">
                                      <td>${r.product_code || "-"}</td>
                                      <td>${r.product_name}</td>
                                      <td class="text-end">${formatNumber(
                                        r.product_sell_price
                                      )}</td>
                                      <td class="text-end">${r.product_stock} ${
                      r.unit?.unit_name
                    }</td>
                                      <td class="text-end"><button data-id="${
                                        r.id
                                      }"  onclick="add_to_cart(this)" class="add-product">+</button></td>
                                  </tr>
                                  `)
                  );
                },
              });
            });
          </script>

          <script>
            var customersearchdata = [];
            document.addEventListener("turbo:load", function () {
              var timer;
              $(".searchCustomerInput").keyup(function (e) {
                if (e.key !== "Enter" || e.keyCode !== 13) {
                  clearTimeout(timer);
                  var ms = 100; // milliseconds
                  var val = this.value;
                  timer = setTimeout(function () {
                    searchCustomer(val);
                  }, ms);
                }
              });
            });

            function change_customer(e) {
              let data = customersearchdata.find(
                (r) => r.id == $(e).attr("data-id")
              );
              $(".customer_name_label").html(data.customer_name);
              $("#customer").val(data.id);
              $("#customer").attr(
                "data-additionalpricecategory",
                data.additional_price_category_id
              );
              let c_apc = data.additional_price_category_id;

              selected_product_data = selected_product_data.map((r) => {
                let ori_price =
                  r?.all_unit.find(
                    (r2) => r2.id == (r?.selected_unit || r?.unit_id)
                  )?.product_sell_price || r?.product_sell_price;

                let price =
                  r.additional_prices.find(
                    (r2) =>
                      r2.additional_price_category_id == c_apc &&
                      r2.additional_price_unit_id ==
                        (r?.selected_unit || r?.unit_id)
                  )?.additional_price ||
                  ori_price ||
                  0;
                console.log({
                  c_apc,
                  additional_prices: r.additional_prices,
                  selected_unit: r?.selected_unit || r?.unit_id,
                  ori_price,
                  price,
                });
                let pqty = parseInt(r?.product_quantity || 0);
                let ptotal = pqty * (price || 0);
                let product_disc_total =
                  (ptotal * parseInt(r?.product_discount || 0)) / 100;
                let convertion_selected = parseFloat(
                  r?.all_unit
                    ? r?.all_unit.find(
                        (r2) => r2.id == (r?.selected_unit || r?.unit_id)
                      )?.convertion
                    : 1
                );
                return {
                  ...r,
                  product_id: parseInt(r.id),
                  id: parseInt(r.id),
                  product_total:
                    ptotal - product_disc_total - (r.cut_price || 0),
                  product_quantity_clean: pqty * convertion_selected,
                  product_price: price,
                };
              });

              const customer_modal = document.querySelector("#customerModal");
              const modal = bootstrap.Modal.getInstance(customer_modal);
              modal.hide();
              refresh_cart_list();
            }

            function searchCustomer(val) {
              $.ajax({
                type: "POST",
                url: "https://poslite.bizkit.id/dashboard/customer/selectajax",
                data: {
                  // "type": "check"
                  search: val,
                  page: 1,
                  // outlet_id: '',
                  saleable: 1,
                },
                success: function (response) {
                  $(".search_customer_list").html("");
                  customersearchdata = response.data;
                  response.data.map((r) => {
                    $(".search_customer_list").append(`
                              <tr  class="lgi">
                                      <td>${r.id}</td>
                                      <td>${r.customer_name}</td>
                                      <td class="text-end">${
                                        r.customer_address || "-"
                                      }</td>
                                      <td class="text-end"><button data-id="${
                                        r.id
                                      }"  onclick="change_customer(this)" class="add-product">+</button></td>
                                  </tr>
                                  `);
                  });
                },
                // $('#productdataTable').DataTable({
                //     "lengthChange": false,
                //     language: {
                //         searchPlaceholder: "Masukkan ID Item atau scan barcode"
                //     }
                // });
              });
            }

            document.addEventListener("turbo:load", function () {
              $.ajax({
                type: "POST",
                url: "https://poslite.bizkit.id/dashboard/customer/selectajax",
                data: {
                  // "type": "check"
                  search: null,
                  page: 1,
                  // outlet_id: '',
                  saleable: 1,
                },
                success: function (response) {
                  $(".search_customer_list").html("");
                  customersearchdata = response.data;

                  response.data.map((r) => {
                    $(".search_customer_list").append(`
                              <tr class="lgi">
                                      <td>${r.id}</td>
                                      <td>${r.customer_name}</td>
                                      <td class="text-end">${
                                        r.customer_address || "-"
                                      }</td>
                                      <td class="text-end"><button data-id="${
                                        r.id
                                      }"  onclick="change_customer(this)" class="add-product">+</button></td>
                                  </tr>
                                  `);
                  });
                },
              });
            });
          </script>

          <a
            onclick=""
            class="btn btn-primary fw-500 h-100 w-100 bg-blue2 border-0 d-flex align-items-center justify-content-center"
            ><img src="" style="height: 30px" class="me-3" />
            CARI BARANG
            <div class="shortcut-button ms-3">(F2)</div></a
          >
          <div class="d-flex justify-content-between w-100 h-100">
            <a
              onclick="open_save_draft_modal()"
              class="btn btn-primary fw-500 bg-blue2 border-0 d-flex align-items-center justify-content-center text-start mb-0"
              style="width: calc(50% - 6px)"
            >
              <img src="" style="height: 23px" class="me-2" />
              <div>
                SAVE<br />DRAFT
                <div class="shortcut-button mt-1">(F3)</div>
              </div>
            </a>
            <a
              onclick="open_draft_modal()"
              class="btn btn-primary fw-500 bg-blue2 border-0 d-flex align-items-center justify-content-center text-start mb-0"
              style="width: calc(50% - 6px)"
            >
              <img src="" style="height: 23px" class="me-2" />
              <div>
                OPEN<br />DRAFT
                <div class="shortcut-button mt-1">(F4)</div>
              </div>
            </a>
          </div>
          <a
            onclick="open_promo_modal()"
            class="btn btn-primary fw-500 w-100 bg-blue2 border-0 d-flex align-items-center justify-content-center h-100"
            ><img src="" style="height: 30px" class="me-3" />
            DAFTAR PROMO
            <div class="shortcut-button ms-3">(F5)</div>
          </a>

          <a
            onclick="open_customer_modal()"
            class="btn btn-primary fw-500 w-100 bg-blue2 border-0 d-flex align-items-center justify-content-center h-100"
          >
            <img src="" style="height: 30px" class="me-3" />
            <div>
              PEMBELI
              <div class="shortcut-button ms-3">(F6)</div>
            </div>
          </a>
        </div>
      </div>
    </main>

    <footer class="d-flex">
      <a href="#"
        ><div class="btn-logout rounded">
          <p class="text-decoration-none text-dark">Magang</p>
          <div class="logout">
            <i class="fa-solid fa-arrow-right-from-bracket text-info "></i>
            <p class="text-decoration-none text-info fw-semibold">Logout</p>
          </div>
          <p class="shortcut-btn">(Shift + Esc)</p>
        </div></a
      >
      <a href="#"
        ><div class="btn-cetakharian biru rounded">
          <!-- Icon -->
          <p class="m-0 text-decoration-none text-white">CETAK HARIAN</p>
          <p class="shortcut-btn">(F8)</p>
        </div></a
      >
      <a href="#"
        ><div class="btn-lihatpenjualan biru rounded">
          <!-- Icon -->
          <p class="m-0 text-decoration-none text-white">LIHAT PENJUALAN</p>
          <p class="shortcut-btn">(F9)</p>
        </div></a
      >
      <a href="#"
        ><div class="btn-pelangganumu light-gray rounded">
          <p class="m-0 text-decoration-none text-dark">Pelanggan</p>
          <p class="m-0 text-decoration-none text-dark">Umum</p>
          <!-- Icon -->
        </div></a
      >
      <a href="#"
        ><div class="btn-promo light-gray d-flex rounded">
          <!-- Flex -->
          <p class="m-0 text-decoration-none text-dark">0 Promo aktif</p>
          <!-- Icon -->
        </div></a
      >
      <a href="#"
        ><div class="info rounded">
          <div class="subtotal">
            <p class="m-0 text-decoration-none text-dark">Subtotal</p>
            <p class="m-0 text-decoration-none text-dark">0</p>
          </div>
          <div class="total">
            <p class="m-0 text-decoration-none text-dark">Total</p>
            <p class="m-0 text-decoration-none text-dark">0</p>
          </div>
        </div></a
      >

      <a href="#"
        ><div class="btn-bayar rounded">
          <!-- Flex -->
          <!-- Icon -->
          <p class="m-0 text-decoration-none text-white">BAYAR</p>
          <p class="shortcut-btn text-white">(F7)</p>
        </div></a
      >
    </footer>

    <script src="script.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  </body>
</html>
